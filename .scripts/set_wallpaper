#!/usr/bin/env bash
set -euo pipefail

wallpapers_dir="$HOME/Wallpapers"
text_file="$wallpapers_dir/.conf/.wallpapers"
initial_count_file="$wallpapers_dir/.conf/.initial_count"
script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

mkdir -p "$(dirname "$text_file")"

if [ ! -f "$text_file" ]; then
	find "$wallpapers_dir" -type f -not -name '.*' >"$text_file"
	wc -l <"$text_file" >"$initial_count_file"
fi

random_wallpaper=$(shuf -n 1 "$text_file")
if [ -z "$random_wallpaper" ]; then
	echo "set_wallpaper: no wallpapers listed in $text_file" >&2
	exit 1
fi

sed -i "\|$random_wallpaper|d" "$text_file"

if [ ! -s "$text_file" ]; then
	find "$wallpapers_dir" -type f -not -name '.*' >"$text_file"
	wc -l <"$text_file" >"$initial_count_file"
fi

initial_count=0
if [ -s "$initial_count_file" ]; then
	initial_count=$(cat "$initial_count_file")
fi

current_count=$(find "$wallpapers_dir" -type f -not -name '.*' | wc -l)
if [ "$initial_count" -ne "$current_count" ]; then
	find "$wallpapers_dir" -type f -not -name '.*' >"$text_file"
	wc -l <"$text_file" >"$initial_count_file"
fi

"$script_dir/change_wallpaper"
